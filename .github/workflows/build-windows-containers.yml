name: Build Windows Containers

on:
  workflow_dispatch:
  push:
    branches:
      - feature/pf5-pf6-containers
    paths:
      - 'containers/windows/**'
      - '.github/workflows/build-windows-containers.yml'

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  build-and-push:
    runs-on: windows-2022
    strategy:
      matrix:
        include:
          - id: pf5
            dockerfile: containers/windows/Dockerfile.pf5
            image: ghcr.io/raizo-tcs/archive-r/pf5-windows-msvc
            smoke: >-
              cmake --version;
              ninja --version;
              python --version;
              ruby --version;
              git --version
          - id: pf6
            dockerfile: containers/windows/Dockerfile.pf6
            image: ghcr.io/raizo-tcs/archive-r/pf6-windows-mingw
            smoke: >-
              cmake --version;
              ninja --version;
              python --version;
              ruby --version;
              git --version;
              bash -lc "which gcc && gcc --version"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show Docker info
        shell: powershell
        run: |
          docker version
          docker info

      - name: Report registry credential source
        shell: powershell
        run: |
          if ("${{ secrets.GHCR_PAT }}" -ne "") {
            Write-Host "GHCR_PAT secret is present; workflow will use it."
          } else {
            Write-Host "GHCR_PAT secret is NOT set; workflow will fall back to GITHUB_TOKEN."
          }
          if ("${{ secrets.GHCR_USER }}" -ne "") {
            Write-Host "GHCR_USER secret override detected."
          } else {
            Write-Host "GHCR_USER secret not set; using default 'raizo-tcs'."
          }

      - name: Login to GitHub Container Registry
        shell: powershell
        env:
          CR_PAT: ${{ secrets.GHCR_PAT != '' && secrets.GHCR_PAT || github.token }}
          CR_USER: ${{ secrets.GHCR_USER != '' && secrets.GHCR_USER || 'raizo-tcs' }}
        run: |
          if (-not $env:CR_PAT -or $env:CR_PAT.Trim().Length -eq 0) {
            throw "CR_PAT is empty. Configure GHCR_PAT (write:packages) or rely on default GITHUB_TOKEN."
          }
          if ($env:CR_PAT.Length -ge 8) {
            $prefix = $env:CR_PAT.Substring(0, 4)
            $suffix = $env:CR_PAT.Substring($env:CR_PAT.Length - 4)
            Write-Host "CR_PAT prefix=$prefix*** suffix=***$suffix"
            if ($prefix -eq 'ghp_' -and $env:CR_PAT.StartsWith('ghp_TGVb') -and $env:CR_PAT.EndsWith('n0rUDRf')) {
              Write-Host "CR_PAT matches expected pattern ghp_TGVb***n0rUDRf"
            } else {
              Write-Host "CR_PAT does NOT match expected pattern ghp_TGVb***n0rUDRf"
            }
          } else {
            Write-Host "CR_PAT shorter than 8 characters; cannot display prefix/suffix"
          }
          $user = if ($env:CR_USER) { $env:CR_USER.Trim() } else { "${{ github.repository_owner }}" }
          Write-Host "Logging into ghcr.io as $user"
          echo $env:CR_PAT | docker login ghcr.io -u $user --password-stdin
          if ($LASTEXITCODE -ne 0) {
            Write-Error "docker login failed. Ensure GHCR terms are accepted for $user and GHCR_PAT has write:packages scope if required."
            exit $LASTEXITCODE
          }

      - name: Build ${{ matrix.id }} image
        shell: powershell
        run: |
          $tags = @(
            "${{ matrix.image }}:latest",
            "${{ matrix.image }}:${{ github.sha }}"
          )
          $tagArgs = $tags | ForEach-Object { "-t", $_ }
          docker build `
            --file "${{ matrix.dockerfile }}" `
            $tagArgs `
            --isolation=process `
            .

      - name: Smoke test ${{ matrix.id }} toolchain
        shell: powershell
        run: |
          docker run --rm --isolation=process `
            "${{ matrix.image }}:latest" `
            powershell -NoLogo -NoProfile -Command "${{ matrix.smoke }}"

      - name: Push ${{ matrix.id }} image
        shell: powershell
        run: |
          docker push ${{ matrix.image }}:latest
          docker push ${{ matrix.image }}:${{ github.sha }}

      - name: Inspect image
        shell: powershell
        run: |
          docker image inspect ${{ matrix.image }}:latest | Out-File -FilePath "${{ runner.temp }}\\${{ matrix.id }}-inspect.json"

      - name: Upload inspect artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.id }}-inspect
          path: "${{ runner.temp }}\\${{ matrix.id }}-inspect.json"
