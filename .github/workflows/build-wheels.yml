name: Build Wheels

on:
  push:
    branches: [main]
    tags: ['v*.*.*']
  pull_request:
    branches: [main]
  workflow_dispatch:
  workflow_call:

permissions:
  contents: read

jobs:
  build-manylinux-wheels:
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        python-tag:
          - cp39-cp39
          - cp310-cp310
          - cp311-cp311
          - cp312-cp312
    env:
      MANYLINUX_IMAGE: quay.io/pypa/manylinux_2_28_x86_64:latest
      LIBARCHIVE_VERSION: 3.7.4
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build wheel for ${{ matrix.python-tag }}
        env:
          PYTHON_TAG: ${{ matrix.python-tag }}
        run: |
          set -euo pipefail
          HOST_UID="$(id -u)"
          HOST_GID="$(id -g)"
          docker run --rm \
            -e HOST_UID="${HOST_UID}" \
            -e HOST_GID="${HOST_GID}" \
            -e PYTHON_TAG="${PYTHON_TAG}" \
            -e LIBARCHIVE_VERSION="${LIBARCHIVE_VERSION}" \
            -v "${{ github.workspace }}:/io" \
            ${{ env.MANYLINUX_IMAGE }} \
            /bin/bash -c "/io/.github/scripts/ci/build_manylinux_wheels.sh"

      - name: List built wheels for ${{ matrix.python-tag }}
        run: |
          set -x
          ls -al bindings/python
          ls -al bindings/python/dist || true
          find bindings/python/dist -maxdepth 2 -type f -name '*.whl' || true
          find . -maxdepth 6 -type f -name '*.whl'

      - name: Upload wheels for ${{ matrix.python-tag }}
        uses: actions/upload-artifact@v4
        if: ${{ env.ACT != 'true' }}
        with:
          name: wheels-${{ matrix.python-tag }}-${{ github.sha }}
          path: bindings/python/dist/${{ matrix.python-tag }}/*.whl
          if-no-files-found: error
          retention-days: 7
