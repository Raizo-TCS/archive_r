name: Build Wheels

on:
  push:
    branches: [main]
    tags: ['v*.*.*']
  pull_request:
    branches: [main]
  workflow_dispatch:
  workflow_call:

permissions:
  contents: read
  packages: read

jobs:
  build-manylinux-wheels:
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        python-tag:
          - cp39-cp39
          - cp310-cp310
          - cp311-cp311
          - cp312-cp312
    env:
      MANYLINUX_IMAGE: quay.io/pypa/manylinux_2_28_x86_64:latest
      LIBARCHIVE_VERSION: 3.7.4
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build wheel for ${{ matrix.python-tag }}
        env:
          PYTHON_TAG: ${{ matrix.python-tag }}
        run: |
          set -euo pipefail
          HOST_UID="$(id -u)"
          HOST_GID="$(id -g)"
          docker run --rm \
            -e HOST_UID="${HOST_UID}" \
            -e HOST_GID="${HOST_GID}" \
            -e PYTHON_TAG="${PYTHON_TAG}" \
            -e LIBARCHIVE_VERSION="${LIBARCHIVE_VERSION}" \
            -v "${{ github.workspace }}:/io" \
            ${{ env.MANYLINUX_IMAGE }} \
            /bin/bash -c "/io/.github/scripts/ci/build_manylinux_wheels.sh"

      - name: List built wheels for ${{ matrix.python-tag }}
        run: |
          set -x
          ls -al bindings/python
          ls -al bindings/python/dist || true
          find bindings/python/dist -maxdepth 2 -type f -name '*.whl' || true
          find . -maxdepth 6 -type f -name '*.whl'

      - name: Upload wheels for ${{ matrix.python-tag }}
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.python-tag }}-${{ github.sha }}
          path: bindings/python/dist/${{ matrix.python-tag }}/*.whl
          if-no-files-found: error
          retention-days: 7

  build-macos-arch-wheels:
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        runner: [macos-13, macos-14]
        python-version: ['3.9', '3.10', '3.11', '3.12']
        include:
          - runner: macos-13
            arch: x86_64
            deployment_target: '11.0'
          - runner: macos-14
            arch: arm64
            deployment_target: '11.0'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install libarchive
        env:
          MACOSX_DEPLOYMENT_TARGET: ${{ matrix.deployment_target }}
          HOMEBREW_NO_INSTALL_CLEANUP: "1"
          HOMEBREW_NO_INSTALL_FROM_API: "1"
        run: |
          set -euo pipefail
          brew update
          # Force build from source to respect MACOSX_DEPLOYMENT_TARGET
          brew install --build-from-source libarchive xz lz4 zstd libb2
          LIBARCHIVE_ROOT="$(brew --prefix libarchive)"
          echo "LIBARCHIVE_ROOT=${LIBARCHIVE_ROOT}" >>"$GITHUB_ENV"
          echo "CMAKE_PREFIX_PATH=${LIBARCHIVE_ROOT}" >>"$GITHUB_ENV"
          echo "LDFLAGS=-L${LIBARCHIVE_ROOT}/lib" >>"$GITHUB_ENV"
          echo "CPPFLAGS=-I${LIBARCHIVE_ROOT}/include" >>"$GITHUB_ENV"
          echo "PKG_CONFIG_PATH=${LIBARCHIVE_ROOT}/lib/pkgconfig" >>"$GITHUB_ENV"

      - name: Build and validate ${{ matrix.arch }} wheel
        env:
          ARCH_NAME: ${{ matrix.arch }}
          DEPLOYMENT_TARGET: ${{ matrix.deployment_target }}
          PY_VERSION: ${{ matrix.python-version }}
        run: |
          set -euo pipefail
          cd bindings/python
          python -m pip install --upgrade pip setuptools wheel pybind11 build delocate
          export MACOSX_DEPLOYMENT_TARGET="${DEPLOYMENT_TARGET}"
          deployment_tag="${DEPLOYMENT_TARGET//./_}"
          export ARCHFLAGS="-arch ${ARCH_NAME}"
          plat_name="macosx_${deployment_tag}_${ARCH_NAME}"
          target_dir="dist/macos-${ARCH_NAME}-${PY_VERSION}"
          mkdir -p "$target_dir"
          python -m pip wheel . -w "$target_dir" --no-deps --config-settings="--build-option=--plat-name=${plat_name}"
          original_wheel=$(ls "$target_dir"/*.whl | head -n 1)
          repair_dir=$(mktemp -d)
          delocate-wheel -v -w "$repair_dir" "$original_wheel"
          rm -f "$target_dir"/*.whl
          mv "$repair_dir"/*.whl "$target_dir"/
          repaired_wheel=$(ls "$target_dir"/*.whl | head -n 1)
          python -m venv .venv
          source .venv/bin/activate
          pip install --no-index "$repaired_wheel"
          python -c "import archive_r; print(f'${ARCH_NAME} validated {archive_r.__version__}')"

      - name: Upload ${{ matrix.arch }} wheels
        uses: actions/upload-artifact@v4
        with:
          name: macos-wheels-${{ matrix.arch }}-py${{ matrix.python-version }}-${{ github.sha }}
          path: bindings/python/dist/macos-${{ matrix.arch }}-${{ matrix.python-version }}/*.whl
          if-no-files-found: error
          retention-days: 7

  build-macos-universal-wheels:
    runs-on: macos-14
    needs: build-macos-arch-wheels
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Download arm64 wheel
        uses: actions/download-artifact@v4
        with:
          name: macos-wheels-arm64-py${{ matrix.python-version }}-${{ github.sha }}
          path: bindings/python/dist/universal-input/arm64

      - name: Download x86_64 wheel
        uses: actions/download-artifact@v4
        with:
          name: macos-wheels-x86_64-py${{ matrix.python-version }}-${{ github.sha }}
          path: bindings/python/dist/universal-input/x86_64

      - name: Fuse wheels into universal2
        env:
          PY_VERSION: ${{ matrix.python-version }}
        run: |
          set -euo pipefail
          cd bindings/python
          python -m pip install --upgrade pip delocate wheel
          arm_wheel=$(ls dist/universal-input/arm64/*.whl | head -n 1)
          x86_wheel=$(ls dist/universal-input/x86_64/*.whl | head -n 1)
          universal_dir="dist/macos-universal-${PY_VERSION}"
          mkdir -p "$universal_dir"
          delocate-merge -w "$universal_dir" "$arm_wheel" "$x86_wheel"
          universal_wheel=$(ls "$universal_dir"/*.whl | head -n 1)
          python -m venv .venv
          source .venv/bin/activate
          pip install --no-index "$universal_wheel"
          python -c "import archive_r; print(f'universal validated {archive_r.__version__}')"

      - name: Upload universal macOS wheels
        uses: actions/upload-artifact@v4
        with:
          name: macos-wheels-universal-py${{ matrix.python-version }}-${{ github.sha }}
          path: bindings/python/dist/macos-universal-${{ matrix.python-version }}/*.whl
          if-no-files-found: error
          retention-days: 7

  build-windows-wheels:
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          architecture: x64

      - name: Login to GitHub Container Registry
        shell: pwsh
        env:
          CR_PAT: ${{ secrets.GHCR_PAT != '' && secrets.GHCR_PAT || github.token }}
          CR_USER: ${{ secrets.GHCR_USER != '' && secrets.GHCR_USER || github.actor }}
        run: |
          $creds = $env:CR_PAT
          if (-not $creds) {
            throw "CR_PAT (or GITHUB_TOKEN) not available"
          }
          $user = $env:CR_USER
          Write-Host "Logging into ghcr.io as $user"
          $creds | docker login ghcr.io -u $user --password-stdin

      - name: Extract libarchive from container
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $image = "ghcr.io/raizo-tcs/archive_r/pf5-windows-msvc:latest"
          Write-Host "Pulling $image..."
          docker pull $image
          
          $dest = "${{ runner.temp }}\vcpkg_libarchive"
          if (Test-Path $dest) { Remove-Item $dest -Recurse -Force }
          mkdir $dest
          
          Write-Host "Extracting libarchive using docker run..."
          # Use docker run with volume mount to copy files to avoid docker cp issues
          docker run --rm `
            -v "${dest}:C:\out" `
            $image `
            powershell -Command "Copy-Item -Path 'C:\vcpkg\installed\x64-windows' -Destination 'C:\out' -Recurse -Force"
          
          $prefix = "$dest\x64-windows"
          if (-not (Test-Path $prefix)) {
             throw "Failed to extract libarchive: $prefix does not exist"
          }
          $binPath = Join-Path $prefix 'bin'
          $includePath = Join-Path $prefix 'include'
          $libPath = Join-Path $prefix 'lib'
          $pkgConfigPath = Join-Path $libPath 'pkgconfig'
          
          Write-Host "Setting environment variables..."
          Add-Content -Path $env:GITHUB_ENV -Value "LIBARCHIVE_ROOT=$prefix" -Encoding utf8
          Add-Content -Path $env:GITHUB_ENV -Value "CMAKE_PREFIX_PATH=$prefix" -Encoding utf8
          Add-Content -Path $env:GITHUB_ENV -Value "CPPFLAGS=-I$includePath" -Encoding utf8
          Add-Content -Path $env:GITHUB_ENV -Value "LDFLAGS=-L$libPath" -Encoding utf8
          Add-Content -Path $env:GITHUB_ENV -Value "PKG_CONFIG_PATH=$pkgConfigPath" -Encoding utf8
          Add-Content -Path $env:GITHUB_ENV -Value "PATH=$binPath;$env:PATH" -Encoding utf8

      - name: Build and repair Windows wheel
        shell: pwsh
        env:
          PY_VERSION: ${{ matrix.python-version }}
        run: |
          $ErrorActionPreference = 'Stop'
          cd bindings\python
          python -m pip install --upgrade pip setuptools wheel pybind11 build delvewheel
          $targetDir = "dist\windows-${env:PY_VERSION}"
          if (Test-Path $targetDir) { Remove-Item $targetDir -Recurse -Force }
          New-Item -ItemType Directory -Path $targetDir | Out-Null
          python -m pip wheel . -w $targetDir --no-deps
          $original = Get-ChildItem $targetDir -Filter *.whl | Select-Object -First 1
          delvewheel repair $original.FullName -w $targetDir --add-path "$env:LIBARCHIVE_ROOT\bin"
          $repaired = Get-ChildItem $targetDir -Filter *.whl | Sort-Object LastWriteTime | Select-Object -Last 1
          Get-ChildItem $targetDir -Filter *.whl | Where-Object { $_.FullName -ne $repaired.FullName } | Remove-Item -Force
          python -m venv .venv
          .\.venv\Scripts\pip install $repaired.FullName
          .\.venv\Scripts\python -c "import archive_r; print(f'validated {archive_r.__version__}')"

      - name: Upload Windows wheels
        uses: actions/upload-artifact@v4
        with:
          name: windows-wheels-py${{ matrix.python-version }}-${{ github.sha }}
          path: bindings/python/dist/windows-${{ matrix.python-version }}/*.whl
          if-no-files-found: error
          retention-days: 7
