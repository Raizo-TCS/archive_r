name: Build Wheels

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
  workflow_call:

permissions:
  contents: read
  packages: write

jobs:
  detect-container-changes:
    name: Detect container-related changes
    runs-on: ubuntu-24.04
    outputs:
      containers_needed: ${{ steps.filter.outputs.containers }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            containers:
              - '.github/docker/**'
              - '.github/workflows/build-containers.yml'
              - 'install-deps-ubuntu.sh'
              - 'install-deps-msvc.ps1'
              - 'bindings/python/tools/build-deps-manylinux.sh'

  build-containers-if-needed:
    name: Build Containers (if needed)
    needs: detect-container-changes
    if: ${{ needs.detect-container-changes.outputs.containers_needed == 'true' }}
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/build-containers.yml

  build-manylinux-wheels:
    needs: [detect-container-changes, build-containers-if-needed]
    if: >-
      ${{ always() &&
          needs.detect-container-changes.result == 'success' &&
          (needs.build-containers-if-needed.result == 'success' || needs.build-containers-if-needed.result == 'skipped') }}
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        platform: [x86_64, aarch64]
        python-tag: [cp310-cp310, cp311-cp311, cp312-cp312, cp313-cp313, cp314-cp314]
    env:
      LIBARCHIVE_VERSION: 3.7.5
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        if: matrix.platform == 'aarch64'
        uses: docker/setup-qemu-action@v3

      - name: Build wheel for ${{ matrix.python-tag }} (${{ matrix.platform }})
        env:
          PYTHON_TAG: ${{ matrix.python-tag }}
          PLATFORM: ${{ matrix.platform }}
        run: |
          set -euo pipefail
          retry_cmd() {
            local attempts=$1
            local delay=$2
            shift 2
            local n=1
            while true; do
              if "$@"; then
                return 0
              fi
              if (( n >= attempts )); then
                return 1
              fi
              echo "[retry ${n}/${attempts}] $* failed; sleeping ${delay}s" >&2
              sleep "$delay"
              n=$((n+1))
            done
          }
          HOST_UID="$(id -u)"
          HOST_GID="$(id -g)"
          OWNER_LOWER="${{ github.repository_owner }}"
          OWNER_LOWER="${OWNER_LOWER,,}"
          if [[ "${PLATFORM}" == "aarch64" ]]; then
            MANYLINUX_IMAGE="ghcr.io/${OWNER_LOWER}/archive_r/manylinux_2_28_aarch64_deps:latest"
            DEPS_PREFIX="/opt/archive_r_deps"
            DOCKER_PLATFORM_ARG="--platform linux/arm64"
            BUILD_CMD="ARCHIVE_R_DEPS_PREFIX=${DEPS_PREFIX} bash bindings/python/tools/build-wheel-manylinux.sh"
          else
            MANYLINUX_IMAGE="quay.io/pypa/manylinux_2_28_x86_64:latest"
            DEPS_PREFIX="/opt/archive_r_deps"
            BUILD_CMD="bash bindings/python/tools/build-deps-manylinux.sh --prefix ${DEPS_PREFIX} && ARCHIVE_R_DEPS_PREFIX=${DEPS_PREFIX} bash bindings/python/tools/build-wheel-manylinux.sh"
          fi
          retry_cmd 3 5 docker pull "${MANYLINUX_IMAGE}" || true
          docker run --rm \
            ${DOCKER_PLATFORM_ARG:-} \
            -e HOST_UID="${HOST_UID}" \
            -e HOST_GID="${HOST_GID}" \
            -e PYTHON_TAG="${PYTHON_TAG}" \
            -e PLATFORM="${PLATFORM}" \
            -e LIBARCHIVE_VERSION="${LIBARCHIVE_VERSION}" \
            -e GITHUB_ENV="/tmp/github_env" \
            -v "${{ github.workspace }}:/io" \
            "${MANYLINUX_IMAGE}" \
            /bin/bash -c "cd /io && ${BUILD_CMD}"

      - name: Upload wheels for ${{ matrix.python-tag }} (${{ matrix.platform }})
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.platform }}-${{ matrix.python-tag }}-${{ github.sha }}
          path: bindings/python/dist/${{ matrix.python-tag }}/*.whl
          if-no-files-found: error
          retention-days: 7

  build-macos-wheels:
    needs: [detect-container-changes, build-containers-if-needed]
    if: >-
      ${{ always() &&
          needs.detect-container-changes.result == 'success' &&
          (needs.build-containers-if-needed.result == 'success' || needs.build-containers-if-needed.result == 'skipped') }}
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 60
    env:
      MACOSX_DEPLOYMENT_TARGET: "11.0"
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13', '3.14']
        runner: [macos-15-intel, macos-15]
        include:
          - runner: macos-15-intel
            arch: x86_64
          - runner: macos-15
            arch: arm64
          - runner: macos-15
            arch: universal2
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Build dependencies (macOS)
        run: bash bindings/python/tools/build-deps-macos.sh --prefix "$(pwd)/libs"

      - name: Build wheel (macOS ${{ matrix.arch }})
        env:
          PY_VERSION: ${{ matrix.python-version }}
          ARCH: ${{ matrix.arch }}
        run: bash bindings/python/tools/build-wheel-macos.sh

      - name: Upload ${{ matrix.arch }} wheels
        uses: actions/upload-artifact@v4
        with:
          name: macos-wheels-${{ matrix.arch }}-py${{ matrix.python-version }}-${{ github.sha }}
          path: bindings/python/dist/macos-${{ matrix.arch }}-${{ matrix.python-version }}/*.whl
          if-no-files-found: error
          retention-days: 7

  build-windows-wheels:
    needs: [detect-container-changes, build-containers-if-needed]
    if: >-
      ${{ always() &&
          needs.detect-container-changes.result == 'success' &&
          (needs.build-containers-if-needed.result == 'success' || needs.build-containers-if-needed.result == 'skipped') }}
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13', '3.14']
        arch: [x86_64]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          architecture: x64

      - name: Install dependencies (MSVC)
        shell: pwsh
        run: pwsh -File install-deps-msvc.ps1

      - name: Build wheel (MSVC ${{ matrix.arch }})
        shell: pwsh
        run: pwsh -File bindings/python/tools/build-wheel-msvc.ps1 -PythonVersion "${{ matrix.python-version }}" -Arch ${{ matrix.arch }}

      - name: Upload Windows wheels
        uses: actions/upload-artifact@v4
        with:
          name: windows-wheels-${{ matrix.arch }}-py${{ matrix.python-version }}-${{ github.sha }}
          path: bindings/python/dist/win_*/*.whl
          if-no-files-found: error
          retention-days: 7
