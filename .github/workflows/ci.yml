name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  packages: read

jobs:
  pf1-linux-x86:
    name: PF1.0 Linux x86_64 Build & Test
    runs-on: ubuntu-24.04
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu x86_64)
        run: ./install-deps-ubuntu.sh

      - name: Build (Ubuntu x86_64)
        run: PACKAGE_MODE=full ./build-on-ubuntu.sh

      - name: Test (Ubuntu x86_64)
        run: ./test-on-ubuntu.sh

      - name: Create Source Archive
        run: |
          VERSION=$(cat VERSION | tr -d '\n')
          git archive --format=tar.gz --prefix=archive_r-core-${VERSION}/ HEAD > archive_r-core-${VERSION}.tar.gz

      - name: Upload PF1.0 artifacts
        if: ${{ always() && env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: archive-r-pf1-x86_64-${{ github.sha }}
          path: |
            archive_r-core-*.tar.gz
            build/bindings/python/dist/**/*
            build/bindings/ruby/**/*.gem
            build/logs/**/*.log
          if-no-files-found: ignore
          retention-days: 7

  pf1-linux-arm64:
    name: PF1.1 Linux arm64 Build & Test (QEMU)
    runs-on: ubuntu-24.04
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU (aarch64)
        uses: docker/setup-qemu-action@v3

      - name: Prepare CI Container
        run: |
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/archive_r/ci-linux-arm64:latest"
          IMAGE_NAME="${IMAGE_NAME,,}"
          if docker pull "$IMAGE_NAME"; then
            echo "CI_IMAGE=$IMAGE_NAME" >> $GITHUB_ENV
          else
            echo "Image not found, building locally..."
            docker build -t ci-linux-arm64:local -f .github/docker/ci-linux-arm64.Dockerfile --platform linux/arm64 .
            echo "CI_IMAGE=ci-linux-arm64:local" >> $GITHUB_ENV
          fi

      - name: Build & Test on arm64
        run: |
          set -euo pipefail
          HOST_UID=$(id -u)
          HOST_GID=$(id -g)
          docker run --rm --platform linux/arm64 \
            -e HOST_UID="$HOST_UID" -e HOST_GID="$HOST_GID" \
            -v "${{ github.workspace }}:/io" \
            -w /io \
            "$CI_IMAGE" \
            bash -c "set -euo pipefail; \
              if ! getent group \"${HOST_GID}\" >/dev/null; then groupadd -g \"${HOST_GID}\" hostgroup; fi; \
              if ! getent passwd \"${HOST_UID}\" >/dev/null; then useradd -m -u \"${HOST_UID}\" -g \"${HOST_GID}\" hostuser; fi; \
              su - hostuser -c 'cd /io && RUN_BINDINGS_TIMEOUT=300 PACKAGE_MODE=bindings ./build-on-ubuntu.sh && RUN_BINDINGS_TIMEOUT=300 ./test-on-ubuntu.sh'"

      - name: Upload PF1.1 artifacts
        if: ${{ always() && env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: archive-r-pf1-arm64-${{ github.sha }}
          path: |
            build/bindings/python/dist/**/*
            build/bindings/ruby/**/*.gem
            build/logs/**/*.log
          if-no-files-found: ignore
          retention-days: 7

  pf2-macos:
    name: ${{ matrix.label }} macOS Build & Test
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-15-intel
            arch: x86_64
            label: PF2.0 macOS 15 x86_64
          - runner: macos-14
            arch: arm64
            label: PF2.1 macOS 14 arm64
    env:
      MACOSX_DEPLOYMENT_TARGET: "11.0"
      HOMEBREW_NO_AUTO_UPDATE: "1"
      HOMEBREW_NO_INSTALL_CLEANUP: "1"
      HOMEBREW_NO_ANALYTICS: "1"
      HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK: "1"
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (macOS)
        run: ./install-deps-macos.sh

      - name: Build (macOS ${{ matrix.arch }})
        env:
          ARCH: ${{ matrix.arch }}
        run: PACKAGE_MODE=full ./build-on-macos.sh

      - name: Test (macOS ${{ matrix.arch }})
        run: ./test-on-macos.sh

      - name: Upload ${{ matrix.label }} artifacts
        if: ${{ always() && env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: archive-r-${{ matrix.arch }}-${{ github.sha }}
          path: |
            build/bindings/python/dist/**/*
            build/bindings/ruby/**/*.gem
            build/logs/**/*.log
          if-no-files-found: ignore
          retention-days: 7

  pf3-msvc:
    name: PF3.0 Windows MSVC Build & Test
    runs-on: windows-2022
    timeout-minutes: 90
    env:
      MACOSX_DEPLOYMENT_TARGET: "11.0"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Install dependencies (MSVC)
        shell: pwsh
        run: ./install-deps-msvc.ps1

      - name: Build (MSVC x64)
        shell: pwsh
        run: ./build-on-msvc.ps1 -PackageMode full

      - name: Test (MSVC x64)
        shell: pwsh
        run: ./test-on-msvc.ps1

      - name: Upload PF3 artifacts
        if: ${{ always() && env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: archive-r-pf3-${{ github.sha }}
          path: |
            build/bindings/python/dist/**/*
            build/bindings/ruby/**/*.gem
            build/logs/**/*.log
          if-no-files-found: ignore
          retention-days: 7

  pf4-mingw:
    name: PF4.0 Windows MinGW Build & Test
    runs-on: windows-2022
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSYS2 (UCRT64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          path-type: minimal

      - name: Install dependencies (MinGW)
        shell: pwsh
        run: ./install-deps-mingw.ps1

      - name: Build (MinGW x86_64)
        shell: pwsh
        run: ./build-on-mingw.ps1 -PackageMode full

      - name: Test (MinGW x86_64)
        shell: pwsh
        run: ./test-on-mingw.ps1

      - name: Upload PF4 artifacts
        if: ${{ always() && env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: archive-r-pf4-${{ github.sha }}
          path: |
            build/bindings/python/dist/**/*
            build/bindings/ruby/**/*.gem
            build/logs/**/*.log
          if-no-files-found: ignore
          retention-days: 7
