name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  build-and-test:
    runs-on: ubuntu-24.04
    timeout-minutes: 90
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        shell: bash
        run: |
          APT_PREFIX="sudo"
          if ! command -v sudo >/dev/null 2>&1; then
            APT_PREFIX=""
          fi
          $APT_PREFIX apt-get update
          $APT_PREFIX apt-get install -y \
            libarchive-dev \
            build-essential \
            cmake \
            python3-dev \
            python3-pip \
            ruby-dev

      - name: Install Python build dependencies
        run: |
          python3 -m pip install --upgrade --ignore-installed pip setuptools wheel --break-system-packages
          python3 -m pip install --upgrade --ignore-installed pybind11 twine build --break-system-packages

      - name: Build archive_r
        run: ./build.sh --rebuild-all --package-python --package-ruby

      - name: Run test suite
        run: timeout 120s ./run_tests.sh

      - name: Upload build artifacts
        if: ${{ always() && env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: archive-r-build-${{ github.sha }}
          path: |
            build/libarchive_r_core.a
            build/bindings/python/dist/*.tar.gz
            build/bindings/python/dist/*.whl
            build/bindings/ruby/*.gem
            build/logs/*.log
          if-no-files-found: ignore
          retention-days: 7

  python-macos-build:
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - runner: macos-13
            arch: x86_64
            python-version: '3.11'
            deployment-target: '13.0'
          - runner: macos-14
            arch: arm64
            python-version: '3.11'
            deployment-target: '14.0'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install libarchive
        run: |
          set -euo pipefail
          brew update
          brew install libarchive
          LIBARCHIVE_ROOT="$(brew --prefix libarchive)"
          echo "LIBARCHIVE_ROOT=${LIBARCHIVE_ROOT}" >> "$GITHUB_ENV"
          echo "CMAKE_PREFIX_PATH=${LIBARCHIVE_ROOT}" >> "$GITHUB_ENV"
          echo "LDFLAGS=-L${LIBARCHIVE_ROOT}/lib" >> "$GITHUB_ENV"
          echo "CPPFLAGS=-I${LIBARCHIVE_ROOT}/include" >> "$GITHUB_ENV"
          echo "PKG_CONFIG_PATH=${LIBARCHIVE_ROOT}/lib/pkgconfig" >> "$GITHUB_ENV"

      - name: Build and validate ${{ matrix.arch }} wheel
        env:
          ARCH_NAME: ${{ matrix.arch }}
          DEPLOYMENT_TARGET: ${{ matrix['deployment-target'] }}
        run: |
          set -euo pipefail
          cd bindings/python
          python -m pip install --upgrade pip setuptools wheel pybind11 build delocate
          export MACOSX_DEPLOYMENT_TARGET="${DEPLOYMENT_TARGET}"
          export ARCHFLAGS="-arch ${ARCH_NAME}"
          deployment_tag="${DEPLOYMENT_TARGET//./_}"
          plat_name="macosx_${deployment_tag}_${ARCH_NAME}"
          target_dir="dist/macos-ci-${ARCH_NAME}"
          mkdir -p "$target_dir"
          python -m pip wheel . -w "$target_dir" --no-deps --config-settings="--build-option=--plat-name=${plat_name}"
          original=$(ls "$target_dir"/*.whl | head -n 1)
          tmp_dir=$(mktemp -d)
          delocate-wheel -v -w "$tmp_dir" "$original"
          rm -f "$target_dir"/*.whl
          mv "$tmp_dir"/*.whl "$target_dir"/
          python -m venv .venv
          source .venv/bin/activate
          pip install --no-index "$target_dir"/*.whl
          python -c "import archive_r; print(f'${ARCH_NAME} wheel ok {archive_r.__version__}')"

      - name: Upload ${{ matrix.arch }} wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: ci-macos-${{ matrix.arch }}-py${{ matrix.python-version }}
          path: bindings/python/dist/macos-ci-${{ matrix.arch }}/*.whl
          if-no-files-found: error

  python-macos-check:
    runs-on: macos-14
    needs: python-macos-build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download arm64 artifact
        uses: actions/download-artifact@v4
        with:
          name: ci-macos-arm64-py3.11
          path: bindings/python/dist/universal-input/arm64

      - name: Download x86_64 artifact
        uses: actions/download-artifact@v4
        with:
          name: ci-macos-x86_64-py3.11
          path: bindings/python/dist/universal-input/x86_64

      - name: Fuse architecture wheels into universal2
        run: |
          set -euo pipefail
          cd bindings/python
          python -m pip install --upgrade pip delocate wheel
          arm_wheel=$(ls dist/universal-input/arm64/*.whl | head -n 1)
          x86_wheel=$(ls dist/universal-input/x86_64/*.whl | head -n 1)
          universal_dir="dist/macos-ci-universal"
          mkdir -p "$universal_dir"
          delocate-merge -w "$universal_dir" "$arm_wheel" "$x86_wheel"
          universal_wheel=$(ls "$universal_dir"/*.whl | head -n 1)
          python -m venv .venv
          source .venv/bin/activate
          pip install --no-index "$universal_wheel"
          python -c "import archive_r; print(f'universal wheel ok {archive_r.__version__}')"

  python-windows-check:
    runs-on: windows-2022
    strategy:
      matrix:
        python-version: ['3.11']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          architecture: x64

      - name: Install libarchive via vcpkg
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (-not $env:VCPKG_INSTALLATION_ROOT) {
            $env:VCPKG_INSTALLATION_ROOT = 'C:\vcpkg'
          }
          vcpkg integrate install
          vcpkg install libarchive:x64-windows
          $prefix = Join-Path $env:VCPKG_INSTALLATION_ROOT 'installed\x64-windows'
          $env:LIBARCHIVE_ROOT = $prefix
          $binPath = Join-Path $prefix 'bin'
          Add-Content -Path $env:GITHUB_ENV -Value "LIBARCHIVE_ROOT=$prefix" -Encoding utf8
          Add-Content -Path $env:GITHUB_ENV -Value "PATH=$binPath;$env:PATH" -Encoding utf8

      - name: Build and validate Windows wheel
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          cd bindings\python
          python -m pip install --upgrade pip setuptools wheel pybind11 build delvewheel
          $wheelDir = "dist\windows-ci"
          $repairedDir = Join-Path $wheelDir 'repaired'
          python -m pip wheel . -w $wheelDir --no-deps
          $original = Get-ChildItem $wheelDir -Filter *.whl | Select-Object -First 1
          if (-not $original) {
            throw 'Wheel build did not produce an artifact'
          }
          New-Item -ItemType Directory -Force -Path $repairedDir | Out-Null
          delvewheel repair $original.FullName -w $repairedDir --add-path "$env:LIBARCHIVE_ROOT\bin"
          Remove-Item $original.FullName
          $repaired = Get-ChildItem $repairedDir -Filter *.whl | Select-Object -First 1
          if (-not $repaired) {
            throw 'delvewheel did not emit a repaired wheel'
          }
          Move-Item $repaired.FullName $wheelDir
          Remove-Item $repairedDir -Recurse -Force
          $finalWheel = Get-ChildItem $wheelDir -Filter *.whl | Select-Object -First 1
          if (-not $finalWheel) {
            throw 'Repaired wheel not found after delvewheel move'
          }
          python -m venv .venv
          .\.venv\Scripts\pip install $finalWheel.FullName
          .\.venv\Scripts\python -c 'import archive_r; print(f"windows wheel ok {archive_r.__version__}")'

  test-macos:
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        runner: [macos-13, macos-14]
        python-version: ['3.11']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install system dependencies
        run: |
          set -euo pipefail
          brew update
          brew install cmake ninja libarchive
          LIBARCHIVE_ROOT="$(brew --prefix libarchive)"
          echo "LIBARCHIVE_ROOT=${LIBARCHIVE_ROOT}" >> "$GITHUB_ENV"
          echo "CMAKE_PREFIX_PATH=${LIBARCHIVE_ROOT}" >> "$GITHUB_ENV"
          echo "LDFLAGS=-L${LIBARCHIVE_ROOT}/lib" >> "$GITHUB_ENV"
          echo "CPPFLAGS=-I${LIBARCHIVE_ROOT}/include" >> "$GITHUB_ENV"
          echo "PKG_CONFIG_PATH=${LIBARCHIVE_ROOT}/lib/pkgconfig" >> "$GITHUB_ENV"

      - name: Install Python build dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip setuptools wheel pybind11

      - name: Build archive_r (macOS)
        run: |
          set -euo pipefail
          ./build.sh --python-only --rebuild-all

      - name: Run test suite (macOS)
        run: |
          set -euo pipefail
          python .github/scripts/ci/run_with_timeout.py 120 ./run_tests.sh

  test-windows:
    runs-on: windows-2022
    env:
      ARCHIVE_R_CMAKE_GENERATOR: "Visual Studio 17 2022"
      ARCHIVE_R_CMAKE_GENERATOR_PLATFORM: "x64"
    strategy:
      matrix:
        python-version: ['3.11']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          architecture: x64

      - name: Set up MSVC developer environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install libarchive via vcpkg
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (-not $env:VCPKG_INSTALLATION_ROOT) {
            $env:VCPKG_INSTALLATION_ROOT = 'C:\\vcpkg'
          }
          vcpkg integrate install
          vcpkg install libarchive:x64-windows
          $prefix = Join-Path $env:VCPKG_INSTALLATION_ROOT 'installed\\x64-windows'
          $binPath = Join-Path $prefix 'bin'
          $includePath = Join-Path $prefix 'include'
          $libPath = Join-Path $prefix 'lib'
          $pkgConfigPath = Join-Path $libPath 'pkgconfig'
          Add-Content -Path $env:GITHUB_ENV -Value "LIBARCHIVE_ROOT=$prefix" -Encoding utf8
          Add-Content -Path $env:GITHUB_ENV -Value "CMAKE_PREFIX_PATH=$prefix" -Encoding utf8
          Add-Content -Path $env:GITHUB_ENV -Value "CPPFLAGS=-I$includePath" -Encoding utf8
          Add-Content -Path $env:GITHUB_ENV -Value "LDFLAGS=-L$libPath" -Encoding utf8
          Add-Content -Path $env:GITHUB_ENV -Value "PKG_CONFIG_PATH=$pkgConfigPath" -Encoding utf8
          Add-Content -Path $env:GITHUB_ENV -Value "PATH=$binPath;$env:PATH" -Encoding utf8

      - name: Install Python build dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip setuptools wheel pybind11

      - name: Build archive_r (Windows)
        shell: bash
        run: |
          set -euo pipefail
          ./build.sh --python-only --rebuild-all

      - name: Run test suite (Windows)
        shell: bash
        run: |
          set -euo pipefail
          python .github/scripts/ci/run_with_timeout.py 120 bash ./run_tests.sh
