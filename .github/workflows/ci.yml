name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  packages: read

jobs:
  pf1-linux:
    name: PF1 Linux Build & Test
    runs-on: ubuntu-24.04
    timeout-minutes: 90
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        shell: bash
        run: |
          APT_PREFIX="sudo"
          if ! command -v sudo >/dev/null 2>&1; then
            APT_PREFIX=""
          fi
          $APT_PREFIX apt-get update
          $APT_PREFIX apt-get install -y \
            libarchive-dev \
            build-essential \
            cmake \
            python3-dev \
            python3-pip \
            ruby-dev

      - name: Install Python build dependencies
        run: |
          python3 -m pip install --upgrade --ignore-installed pip setuptools wheel --break-system-packages
          python3 -m pip install --upgrade --ignore-installed pybind11 twine build --break-system-packages

      - name: Build archive_r
        run: ./build.sh --rebuild-all --package-python --package-ruby

      - name: Run test suite
        run: python3 .github/scripts/ci/run_with_timeout.py 120 ./run_tests.sh

      - name: Upload PF1 artifacts
        if: ${{ always() && env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: archive-r-pf1-${{ github.sha }}
          path: |
            build/libarchive_r_core.a
            build/bindings/python/dist/*.tar.gz
            build/bindings/python/dist/*.whl
            build/bindings/ruby/*.gem
            build/logs/**/*.log
          if-no-files-found: ignore
          retention-days: 7

  macos-platforms:
    name: ${{ matrix.platform }} macOS Build & Test
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: PF3
            runner: macos-13
            arch: x86_64
          - platform: PF4
            runner: macos-14
            arch: arm64
    env:
      HOMEBREW_NO_AUTO_UPDATE: "1"
      HOMEBREW_NO_INSTALL_CLEANUP: "1"
      HOMEBREW_NO_ANALYTICS: "1"
      MACOSX_DEPLOYMENT_TARGET: "11.0"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Homebrew dependencies
        shell: bash
        run: |
          set -euo pipefail
          brew update
          brew install cmake ninja pkg-config libarchive ruby
          LIBARCHIVE_ROOT="$(brew --prefix libarchive)"
          echo "LIBARCHIVE_ROOT=${LIBARCHIVE_ROOT}" >>"$GITHUB_ENV"
          echo "CMAKE_PREFIX_PATH=${LIBARCHIVE_ROOT}" >>"$GITHUB_ENV"
          echo "LDFLAGS=-L${LIBARCHIVE_ROOT}/lib" >>"$GITHUB_ENV"
          echo "CPPFLAGS=-I${LIBARCHIVE_ROOT}/include" >>"$GITHUB_ENV"
          echo "PKG_CONFIG_PATH=${LIBARCHIVE_ROOT}/lib/pkgconfig" >>"$GITHUB_ENV"

      - name: Provide nproc helper
        shell: bash
        run: |
          set -euo pipefail
          cat <<'EOF' >/tmp/nproc.sh
          #!/bin/bash
          if command -v sysctl >/dev/null 2>&1; then
            sysctl -n hw.logicalcpu
          else
            printf "1\n"
          fi
          EOF
          sudo mv /tmp/nproc.sh /usr/local/bin/nproc
          sudo chmod +x /usr/local/bin/nproc

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python build dependencies
        run: |
          python3 -m pip install --upgrade pip setuptools wheel pybind11 build twine

      - name: Build archive_r (macOS)
        run: ./build.sh --rebuild-all --package-python --package-ruby

      - name: Run test suite (macOS)
        run: python3 .github/scripts/ci/run_with_timeout.py 120 ./run_tests.sh

      - name: Upload ${{ matrix.platform }} artifacts
        if: ${{ always() && env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: archive-r-${{ matrix.platform }}-${{ github.sha }}
          path: |
            build/bindings/python/dist/*.tar.gz
            build/bindings/python/dist/*.whl
            build/bindings/ruby/*.gem
            build/logs/**/*.log
          if-no-files-found: ignore
          retention-days: 7

  windows-platforms:
    name: ${{ matrix.display }} Windows Container Build & Test
    runs-on: windows-2022
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: pf5
            display: PF5
            image: ghcr.io/raizo-tcs/archive_r/pf5-windows-msvc
          - id: pf6
            display: PF6
            image: ghcr.io/raizo-tcs/archive_r/pf6-windows-mingw
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show Docker info
        shell: pwsh
        run: |
          docker version
          docker info

      - name: Login to GitHub Container Registry
        shell: pwsh
        env:
          CR_PAT: ${{ secrets.GHCR_PAT != '' && secrets.GHCR_PAT || github.token }}
          CR_USER: ${{ secrets.GHCR_USER != '' && secrets.GHCR_USER || 'raizo-tcs' }}
        run: |
          $creds = $env:CR_PAT
          if (-not $creds -or $creds.Trim().Length -eq 0) {
            throw "CR_PAT is empty. Configure GHCR_PAT (write:packages) or rely on default GITHUB_TOKEN."
          }
          $user = if ($env:CR_USER) { $env:CR_USER.Trim() } else { "${{ github.repository_owner }}" }
          Write-Host "Logging into ghcr.io as $user"
          $creds | docker login ghcr.io -u $user --password-stdin
          if ($LASTEXITCODE -ne 0) {
            Write-Error "docker login failed. Ensure GHCR terms are accepted for $user and GHCR_PAT has write:packages scope if required."
            exit $LASTEXITCODE
          }

      - name: Pull ${{ matrix.display }} image
        id: pull-image
        shell: pwsh
        env:
          IMAGE_NAME: ${{ matrix.image }}
        run: |
          $tags = @("${{ github.sha }}", "latest")
          $selected = $null
          foreach ($tag in $tags) {
            Write-Host "Attempting to pull $env:IMAGE_NAME`:$tag..."
            docker pull "$env:IMAGE_NAME`:$tag"
            if ($LASTEXITCODE -eq 0) {
              $selected = $tag
              break
            }
            Write-Host "Failed to pull $env:IMAGE_NAME`:$tag"
          }
          if (-not $selected) {
            throw "Unable to pull any tag for $env:IMAGE_NAME"
          }
          "selected_tag=$selected" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Run ${{ matrix.display }} build and tests
        shell: pwsh
        env:
          IMAGE_NAME: ${{ matrix.image }}
          SELECTED_TAG: ${{ steps.pull-image.outputs.selected_tag }}
        run: |
          $workspace = "${{ github.workspace }}"
          $imageRef = "$env:IMAGE_NAME`:$env:SELECTED_TAG"
          $runArgs = @(
            "--rm",
            "--isolation=process",
            "-e", "ARCHIVE_R_WORKSPACE=C:\workspace",
            "-v", "$workspace:C:\workspace"
          )
          docker run @runArgs `
            $imageRef `
            powershell -NoLogo -ExecutionPolicy Bypass -File C:\workspace\ci\windows\run_platform_ci.ps1 -Platform ${{ matrix.id }}

      - name: Upload ${{ matrix.display }} artifacts
        if: ${{ always() && env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: archive-r-${{ matrix.display }}-${{ github.sha }}
          path: |
            build/bindings/python/dist/*.tar.gz
            build/bindings/python/dist/*.whl
            build/bindings/ruby/*.gem
            build/logs/**/*.log
          if-no-files-found: ignore
          retention-days: 7
