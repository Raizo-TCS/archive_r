name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  build-and-test:
    runs-on: ubuntu-24.04
    timeout-minutes: 90
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        shell: bash
        run: |
          APT_PREFIX="sudo"
          if ! command -v sudo >/dev/null 2>&1; then
            APT_PREFIX=""
          fi
          $APT_PREFIX apt-get update
          $APT_PREFIX apt-get install -y \
            libarchive-dev \
            build-essential \
            cmake \
            python3-dev \
            python3-pip \
            ruby-dev

      - name: Install Python build dependencies
        run: |
          python3 -m pip install --upgrade --ignore-installed pip setuptools wheel --break-system-packages
          python3 -m pip install --upgrade --ignore-installed pybind11 twine build --break-system-packages

      - name: Build archive_r
        run: ./build.sh --rebuild-all --package-python --package-ruby

      - name: Run test suite
        run: timeout 120s ./run_tests.sh

      - name: Upload build artifacts
        if: ${{ always() && env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: archive-r-build-${{ github.sha }}
          path: |
            build/libarchive_r_core.a
            build/bindings/python/dist/*.tar.gz
            build/bindings/python/dist/*.whl
            build/bindings/ruby/*.gem
            build/logs/*.log
          if-no-files-found: ignore
          retention-days: 7

  python-macos-check:
    runs-on: macos-14
    strategy:
      matrix:
        python-version: ['3.11']
    env:
      MACOSX_DEPLOYMENT_TARGET: '11.0'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install libarchive
        run: |
          set -euo pipefail
          brew update
          brew install libarchive
          echo "LIBARCHIVE_ROOT=$(brew --prefix libarchive)" >> "$GITHUB_ENV"

      - name: Build and validate macOS wheel
        run: |
          set -euo pipefail
          cd bindings/python
          python -m pip install --upgrade pip setuptools wheel pybind11 build delocate
          export ARCHFLAGS='-arch arm64'
          python -m pip wheel . -w dist/macos-ci --no-deps
          original=$(ls dist/macos-ci/*.whl | head -n 1)
          tmp_dir=$(mktemp -d)
          delocate-wheel -v -w "$tmp_dir" "$original"
          rm -f dist/macos-ci/*.whl
          mv "$tmp_dir"/*.whl dist/macos-ci/
          python -m venv .venv
          source .venv/bin/activate
          pip install --no-index dist/macos-ci/*.whl
          python -c "import archive_r; print(f'macos wheel ok {archive_r.__version__}')"

  python-windows-check:
    runs-on: windows-2022
    strategy:
      matrix:
        python-version: ['3.11']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          architecture: x64

      - name: Install libarchive via vcpkg
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (-not $env:VCPKG_INSTALLATION_ROOT) {
            $env:VCPKG_INSTALLATION_ROOT = 'C:\vcpkg'
          }
          vcpkg integrate install
          vcpkg install libarchive:x64-windows
          $prefix = Join-Path $env:VCPKG_INSTALLATION_ROOT 'installed\x64-windows'
          $env:LIBARCHIVE_ROOT = $prefix
          $binPath = Join-Path $prefix 'bin'
          Add-Content -Path $env:GITHUB_ENV -Value "LIBARCHIVE_ROOT=$prefix" -Encoding utf8
          Add-Content -Path $env:GITHUB_ENV -Value "PATH=$binPath;$env:PATH" -Encoding utf8

      - name: Build and validate Windows wheel
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          cd bindings\python
          python -m pip install --upgrade pip setuptools wheel pybind11 build delvewheel
          python -m pip wheel . -w dist\windows-ci --no-deps
          $original = Get-ChildItem dist\windows-ci -Filter *.whl | Select-Object -First 1
          delvewheel repair $original.FullName -w dist\windows-ci --add-path "$env:LIBARCHIVE_ROOT\bin"
          Remove-Item $original.FullName
          python -m venv .venv
          .\.venv\Scripts\pip install dist\windows-ci\*.whl
          .\.venv\Scripts\python -c "import archive_r; print(\"windows wheel ok {0}\" -f (archive_r.__version__))"

  test-macos:
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        runner: [macos-13, macos-14]
        python-version: ['3.11']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install system dependencies
        run: |
          set -euo pipefail
          brew update
          brew install cmake ninja libarchive

      - name: Install Python build dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip setuptools wheel pybind11

      - name: Build archive_r (macOS)
        run: |
          set -euo pipefail
          ./build.sh --python-only --rebuild-all

      - name: Run test suite (macOS)
        run: |
          set -euo pipefail
          python .github/scripts/ci/run_with_timeout.py 120 ./run_tests.sh

  test-windows:
    runs-on: windows-2022
    strategy:
      matrix:
        python-version: ['3.11']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          architecture: x64

      - name: Install build prerequisites
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          choco install ninja --no-progress -y

      - name: Install Python build dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip setuptools wheel pybind11

      - name: Build archive_r (Windows)
        shell: bash
        run: |
          set -euo pipefail
          ./build.sh --python-only --rebuild-all

      - name: Run test suite (Windows)
        shell: bash
        run: |
          set -euo pipefail
          python .github/scripts/ci/run_with_timeout.py 120 ./run_tests.sh
