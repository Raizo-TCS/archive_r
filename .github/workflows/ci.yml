name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  build-and-test:
    runs-on: ubuntu-24.04
    timeout-minutes: 90
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        shell: bash
        run: |
          APT_PREFIX="sudo"
          if ! command -v sudo >/dev/null 2>&1; then
            APT_PREFIX=""
          fi
          $APT_PREFIX apt-get update
          $APT_PREFIX apt-get install -y \
            libarchive-dev \
            build-essential \
            cmake \
            python3-dev \
            python3-pip \
            ruby-dev

      - name: Install Python build dependencies
        run: |
          python3 -m pip install --upgrade --ignore-installed pip setuptools wheel --break-system-packages
          python3 -m pip install --upgrade --ignore-installed pybind11 twine build --break-system-packages

      - name: Build archive_r
        run: ./build.sh --rebuild-all --package-python --package-ruby

      - name: Run test suite
        run: timeout 120s ./run_tests.sh

      - name: Upload build artifacts
        if: ${{ env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: archive-r-build-${{ github.sha }}
          path: |
            build/libarchive_r_core.a
            build/bindings/python/dist/*.tar.gz
            build/bindings/python/dist/*.whl
            build/bindings/ruby/*.gem
          if-no-files-found: ignore
          retention-days: 7
