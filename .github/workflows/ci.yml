name: CI

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  packages: read

jobs:
  pf1-linux-x86_64:
    name: PF1.0 Linux x86_64 Build & Test
    runs-on: ubuntu-24.04
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu x86_64)
        run: sudo ./install-deps-ubuntu.sh

      - name: Build (Ubuntu x86_64)
        run: PACKAGE_MODE=full ./build-on-ubuntu.sh

      - name: Test (Ubuntu x86_64)
        run: ./test-on-ubuntu.sh

      - name: Create Source Archive
        run: |
          VERSION=$(cat VERSION | tr -d '\n')
          git archive --format=tar.gz --prefix=archive_r-core-${VERSION}/ HEAD > archive_r-core-${VERSION}.tar.gz

      - name: Upload PF1.0 artifacts
        if: ${{ always() && env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: archive-r-pf1-x86_64-${{ github.sha }}
          path: |
            archive_r-core-*.tar.gz
            build/bindings/python/dist/**/*
            build/bindings/ruby/**/*.gem
            build/logs/**/*.log
          if-no-files-found: ignore
          retention-days: 7

  ruby-2-7-linux-x86_64:
    name: Ruby 2.7 Linux x86_64 Binding Build & Test
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby 2.7
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '2.7'

      - name: Install dependencies (Ubuntu x86_64)
        run: sudo ./install-deps-ubuntu.sh

      - name: Build (Ruby binding only)
        run: PACKAGE_MODE=ruby ./build-on-ubuntu.sh

      - name: Test (Core + Ruby binding)
        run: ./test-on-ubuntu.sh

      - name: Verify Ruby binding tests executed
        run: |
          test -s build/logs/ruby_test.log
          test -s build/logs/ruby_gem_install.log

      - name: Upload Ruby 2.7 artifacts
        if: ${{ always() && env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: archive-r-ruby27-${{ github.sha }}
          path: |
            build/bindings/ruby/**/*.gem
            build/logs/**/*.log
          if-no-files-found: ignore
          retention-days: 7

  pf1-linux-arm64:
    name: PF1.1 Linux arm64 Build & Test (Hybrid)
    runs-on: ubuntu-24.04
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU (aarch64)
        uses: docker/setup-qemu-action@v3

      - name: Pull Cross-Build Image (Required)
        run: |
          set -euo pipefail
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/archive_r/ci-linux-arm64-cross:latest"
          IMAGE_NAME="${IMAGE_NAME,,}"
          if ! docker pull "$IMAGE_NAME"; then
            echo "Required image not found: $IMAGE_NAME"
            echo "Run the 'Build Containers' workflow to publish CI images to GHCR."
            exit 1
          fi
          echo "CROSS_IMAGE=$IMAGE_NAME" >> $GITHUB_ENV

      - name: Pull Test Image (Required)
        run: |
          set -euo pipefail
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/archive_r/ci-linux-arm64:latest"
          IMAGE_NAME="${IMAGE_NAME,,}"
          if ! docker pull --platform linux/arm64 "$IMAGE_NAME"; then
            echo "Required image not found: $IMAGE_NAME"
            echo "Run the 'Build Containers' workflow to publish CI images to GHCR."
            exit 1
          fi
          echo "CI_IMAGE=$IMAGE_NAME" >> $GITHUB_ENV

      - name: Build Core (Cross-Compile)
        run: |
          set -euo pipefail
          HOST_UID=$(id -u)
          HOST_GID=$(id -g)
          # Run build.sh --rebuild to build Core and Tests (but not bindings)
          # We run as root for simplicity and chown artifacts back to host user
          # Ensure chown runs even if build fails to avoid permission issues
          docker run --rm \
            -v "${{ github.workspace }}:/io" \
            -w /io \
            "$CROSS_IMAGE" \
            bash -c "(./build.sh --rebuild || (chown -R ${HOST_UID}:${HOST_GID} build && exit 1)) && chown -R ${HOST_UID}:${HOST_GID} build"

      - name: Build Bindings & Test (QEMU)
        run: |
          set -euo pipefail
          HOST_UID=$(id -u)
          HOST_GID=$(id -g)
          # Run build.sh --bindings-only to build Python/Ruby bindings linking against the cross-compiled core
          # Then run tests
          docker run --rm --platform linux/arm64 \
            -e HOST_UID="$HOST_UID" -e HOST_GID="$HOST_GID" \
            -v "${{ github.workspace }}:/io" \
            -w /io \
            "$CI_IMAGE" \
            bash -c "set -euo pipefail; \
              if ! getent group \"${HOST_GID}\" >/dev/null; then groupadd -g \"${HOST_GID}\" hostgroup; fi; \
              if ! getent passwd \"${HOST_UID}\" >/dev/null; then useradd -m -u \"${HOST_UID}\" -g \"${HOST_GID}\" -s /bin/bash hostuser; fi; \
              su - hostuser -c 'cd /io && ./build.sh --bindings-only --with-python --with-ruby && ./run_tests.sh'"

      - name: Upload PF1.1 artifacts
        if: ${{ always() && env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: archive-r-pf1-arm64-${{ github.sha }}
          path: |
            build/bindings/python/dist/**/*
            build/bindings/ruby/**/*.gem
            build/logs/**/*.log
          if-no-files-found: ignore
          retention-days: 7

  pf2-macos:
    name: ${{ matrix.label }} macOS Build & Test
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-15-intel
            arch: x86_64
            label: PF2.0 macOS 15 x86_64
          - runner: macos-15
            arch: arm64
            label: PF2.1 macOS 15 arm64
    env:
      MACOSX_DEPLOYMENT_TARGET: "11.0"
      HOMEBREW_NO_AUTO_UPDATE: "1"
      HOMEBREW_NO_INSTALL_CLEANUP: "1"
      HOMEBREW_NO_ANALYTICS: "1"
      HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK: "1"
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (macOS)
        run: ./install-deps-macos.sh

      - name: Build (macOS ${{ matrix.arch }})
        env:
          ARCH: ${{ matrix.arch }}
        run: PACKAGE_MODE=full ./build-on-macos.sh

      - name: Test (macOS ${{ matrix.arch }})
        run: ./test-on-macos.sh

      - name: Upload ${{ matrix.label }} artifacts
        if: ${{ always() && env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: archive-r-${{ matrix.arch }}-${{ github.sha }}
          path: |
            build/bindings/python/dist/**/*
            build/bindings/ruby/**/*.gem
            build/logs/**/*.log
          if-no-files-found: ignore
          retention-days: 7

  pf3-msvc:
    name: PF3.0 Windows MSVC Build & Test
    runs-on: windows-2022
    timeout-minutes: 120
    env:
      MACOSX_DEPLOYMENT_TARGET: "11.0"
    steps:
      - uses: actions/checkout@v4

      - name: Prepare CI Container
        shell: pwsh
        run: |
          $ImageName = "ghcr.io/${{ github.repository_owner }}/archive_r/ci-windows-msvc:latest"
          $ImageName = $ImageName.ToLower()
          docker pull $ImageName
          "CI_IMAGE=$ImageName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Build & Test (MSVC Container)
        shell: pwsh
        run: |
          # Run build and test inside the container
          # We map the workspace to C:\io
          docker run --rm `
            -v "${{ github.workspace }}:C:\io" `
            -w "C:\io" `
            $env:CI_IMAGE `
            powershell -Command "`$ErrorActionPreference = 'Stop'; .\build-on-msvc.ps1 -PackageMode python; .\test-on-msvc.ps1 -PackageMode python"

      - name: Upload PF3 artifacts
        if: ${{ always() && env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: archive-r-pf3-${{ github.sha }}
          path: |
            build/bindings/python/dist/**/*
            build/bindings/ruby/**/*.gem
            build/logs/**/*.log
          if-no-files-found: ignore
          retention-days: 7

  pf4-mingw:
    name: PF4.0 Windows MinGW Build & Test
    runs-on: windows-2022
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4

      - name: Prepare CI Container
        shell: pwsh
        run: |
          $ImageName = "ghcr.io/${{ github.repository_owner }}/archive_r/ci-windows-mingw:latest"
          $ImageName = $ImageName.ToLower()
          docker pull $ImageName
          "CI_IMAGE=$ImageName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Build & Test (MinGW Container)
        shell: pwsh
        run: |
          # Run build and test inside the container
          # We map the workspace to C:\io
          docker run --rm `
            -e ARCHIVE_R_BUILD_NO_ISOLATION=1 `
            -e ARCHIVE_R_SKIP_TWINE_CHECK=1 `
            -v "${{ github.workspace }}:C:\io" `
            -w "C:\io" `
            $env:CI_IMAGE `
            powershell -Command "`$ErrorActionPreference = 'Stop'; .\build-on-mingw.ps1 -PackageMode full; .\test-on-mingw.ps1"

      - name: Upload PF4 artifacts
        if: ${{ always() && env.ACT != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: archive-r-pf4-${{ github.sha }}
          path: |
            build/bindings/python/dist/**/*
            build/bindings/ruby/**/*.gem
            build/logs/**/*.log
          if-no-files-found: ignore
          retention-days: 7
